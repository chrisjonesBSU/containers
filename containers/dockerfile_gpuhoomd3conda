FROM cmelab/gpuconda:latest

ENV CONDA_OVERRIDE_CUDA=11.7

RUN conda update -n base -c defaults conda && \
    conda info && \
    conda install libarchive mamba -n base -c conda-forge && \
    mamba install -c conda-forge hoomd=3*=*gpu* cudatoolkit=11.7 python && \
    mamba install -c conda-forge ipywidgets=7.5.1 jupyterlab=2.1.5 nodejs notebook && \ 
    mamba install -c conda-forge mbuild gsd ipython ipykernel mdanalysis foyer ipywidgets widgetsnbextension nglview=2.7.7 freud cassandra py3Dmol ele mdtraj rdkit scipy networkx intermol numpy packmol parmed pip physical_validation && \ 
    mamba install -c conda-forge fresnel openbabel pillow pyside2 rowan && \ 
    mamba install -c conda-forge -c jaimergp/label/unsupported-cudatoolkit-shim cmeutils signac signac-flow && \
    mamba install -c conda-forge vim openssh && \
    conda install gromacs=*=mpi* -c bioconda -c conda-forge

ENV NODE_OPTIONS=--openssl-legacy-provider

RUN git clone https://github.com/arose/nglview &&\
    nglview install && nglview enable &&\
    jupyter labextension install @jupyter-widgets/jupyterlab-manager --no-build &&\
    jupyter labextension install nglview-js-widgets@2.7.7 &&\
    jupyter-nbextension enable nglview --py --sys-prefix 

RUN git clone https://github.com/cmelab/GIXStapose.git && \
    cd GIXStapose && \
    pip install . && \ 
    cd 

RUN git clone https://github.com/cmelab/polybinder.git && \
    cd polybinder && \
    pip install .
    
# configure unprivileged user
RUN useradd --create-home --shell /bin/bash icomse-software 
USER icomse-software:icomse-software
